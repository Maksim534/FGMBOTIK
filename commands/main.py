import random
from datetime import datetime

from aiogram import Dispatcher, types
from aiogram.filters import Command

from assets.antispam import antispam
from commands.db import getban
from assets.classes import CustomEvent
from assets import keyboards as kb
import config as cfg
from user import BFGuser
from datetime import datetime, timedelta  # –î–æ–±–∞–≤—å—Ç–µ timedelta –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç

CONFIG = {
    "hello_text": f'''ü§ñ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä {cfg.bot_name}!</b>

–ü—Ä–∏–≤–µ—Ç, –ö—Ç–æ-—Ç–æ! –Ø ‚Äî —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫. –ó–¥–µ—Å—å —Ç—ã –Ω–∞–π–¥—ë—à—å –≤—Å—ë –¥–ª—è —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º—è–ø—Ä–µ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è: –æ—Ç —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–æ –∞–∑–∞—Ä—Ç–Ω—ã—Ö –∏–≥—Ä.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<b>üèÜ –û–°–ù–û–í–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üíº <b>–≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ –±–∏–∑–Ω–µ—Å</b>
‚Ä¢ –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –¥–µ–Ω—å–≥–∏, –æ—Ç–∫—Ä—ã–≤–∞–π –∏ —É–ª—É—á—à–∞–π —Å–≤–æ–π –±–∏–∑–Ω–µ—Å
‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π –≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, –ø–æ–∫—É–ø–∞–π –∞–≤—Ç–æ–º–æ–±–∏–ª–∏ –∏ —è—Ö—Ç—ã
‚Ä¢ –û—Ç–∫—Ä–æ–π –≤–∫–ª–∞–¥ –≤ –±–∞–Ω–∫–µ –∏ –ø–æ–ª—É—á–∞–π –ø—Ä–æ—Ü–µ–Ω—Ç—ã

üéÆ <b>–ò–≥—Ä—ã –∏ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</b>
‚Ä¢ –ò—Å–ø—ã—Ç–∞–π —É–¥–∞—á—É –≤ –∫–∞–∑–∏–Ω–æ, —Å–ª–æ—Ç–∞—Ö –∏ –¥—Ä—É–≥–∏—Ö –∞–∑–∞—Ä—Ç–Ω—ã—Ö –∏–≥—Ä–∞—Ö
‚Ä¢ –°–æ—Ä–µ–≤–Ω—É–π—Å—è —Å –¥—Ä—É–∑—å—è–º–∏ –≤ –º–∏–Ω–∏-–∏–≥—Ä–∞—Ö
‚Ä¢ –°–æ–∑–¥–∞–π –∏–ª–∏ –≤—Å—Ç—É–ø–∏ –≤ –∫–ª–∞–Ω, —É—á–∞—Å—Ç–≤—É–π –≤ –∫–ª–∞–Ω–æ–≤—ã—Ö –±–∏—Ç–≤–∞—Ö

üë• <b>–°–æ—Ü–∏–∞–ª—å–Ω–∞—è –∂–∏–∑–Ω—å</b>
‚Ä¢ –ù–∞—Ö–æ–¥–∏ –¥—Ä—É–∑–µ–π, —Å–æ–∑–¥–∞–≤–∞–π —Å–µ–º—å–∏
‚Ä¢ –û–±–º–µ–Ω–∏–≤–∞–π—Å—è —Ä–µ—Å—É—Ä—Å–∞–º–∏ –∏ –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏
‚Ä¢ –°–æ—Ä–µ–≤–Ω—É–π—Å—è –∑–∞ –º–µ—Å—Ç–æ –≤ —Ç–æ–ø–µ –∏–≥—Ä–æ–∫–æ–≤

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<b>üìö –ü–û–õ–ï–ó–ù–´–ï –°–°–´–õ–ö–ò</b>
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üîπ <b>–í—Å–µ –∫–æ–º–∞–Ω–¥—ã</b> ‚Äî –≤–≤–µ–¥–∏ /help
üîπ <b>–ù–∞—à –∫–∞–Ω–∞–ª</b> ‚Äî {cfg.channel}
üîπ <b>–ß–∞—Ç –∏–≥—Ä–æ–∫–æ–≤</b> ‚Äî {cfg.chat}

<i>–ü—Ä–∏—è—Ç–Ω–æ–π –∏–≥—Ä—ã –∏ –±–æ–ª—å—à–∏—Ö –ø–æ–±–µ–¥! üöÄ</i>'''
}


async def on_start(message: types.Message):
    if len(message.text) >= 2:
        await CustomEvent.emit('start_event', {'message': message})

    ban = await getban(message.from_user.id)
    
    if ban:
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º +2 —á–∞—Å–∞ –∫ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–∫–∞–∫ —É –≤–∞—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
        moscow_time = datetime.fromtimestamp(ban[1]) + timedelta(hours=2)
        dtime = moscow_time.strftime('%Y-%m-%d –≤ %H:%M:%S')
        
        await message.answer(f'‚õîÔ∏è –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ –±–æ—Ç–µ –¥–æ <b>{dtime} –ú–°–ö</b>\n–ü—Ä–∏—á–∏–Ω–∞: <i>{ban[2]}</i>')
        return
    
    # –ï–î–ò–ù–°–¢–í–ï–ù–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï - –≤—Å—ë –≤ –æ–¥–Ω–æ–º
    await message.answer(
        CONFIG["hello_text"], 
        disable_web_page_preview=True, 
        reply_markup=kb.start()
    )

async def terms_cmd(message: types.Message):
    await message.answer("""üìÑ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</b>

1. <b>–û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è</b>
1.1. –ù–∞—Å—Ç–æ—è—â–µ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç –æ—Ç–Ω–æ—à–µ–Ω–∏—è –º–µ–∂–¥—É –≤–ª–∞–¥–µ–ª—å—Ü–µ–º –±–æ—Ç–∞ (–¥–∞–ª–µ–µ ¬´–ë–æ—Ç¬ª –∏–ª–∏ ¬´–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è¬ª) –∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.
1.2. –ò—Å–ø–æ–ª—å–∑—É—è –ë–æ—Ç–∞, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –¥–∞–Ω–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è.
1.3. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å —Å–∞–π—Ç–∞ –≤ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö —Ü–µ–ª—è—Ö.

2. <b>–ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏</b>
2.1. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—è–∑—É–µ—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞.
2.2. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞.
2.3. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –∏–∑–º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞, —É–¥–∞–ª—è—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã –∏ –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ç–µ—Ö.—Ä–∞–±–æ—Ç—ã.
2.4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è —Å–æ–±–ª—é–¥–∞—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –∏ –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å —Ä–∞–±–æ—Ç—É –±–æ—Ç–∞.
2.5. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏ –±–æ—Ç–æ–≤.

3. <b>–ü–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è</b>
3.1. –í—Å–µ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω—ã –∏ –Ω–µ –ø–æ–¥–ª–µ–∂–∞—Ç –≤–æ–∑–≤—Ä–∞—Ç—É.
3.2. –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏–µ –≤—ã–¥–∞–µ—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ —Å—É—Ç–æ–∫.
3.3. –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ ‚Äî –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.

4. <b>–î–µ–π—Å—Ç–≤–∏–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è</b>
4.1. –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –º–æ–º–µ–Ω—Ç–∞ –Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞.
4.2. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ.
4.3. –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è ‚Äî –±–µ—Å—Å—Ä–æ—á–Ω–æ.
4.4. –ò–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–≥—É—Ç —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º.""")


@antispam
async def new_message(message: types.Message, user: BFGuser):
    # –î–ª—è –≤—ã–∑–æ–≤–∞ –≤ –º–æ–¥—É–ª—è—Ö —Å –ø–æ–º–æ—â—å—é FunEvent.subscribe("new_message", –≤–∞—à–∞_—Ñ—É–Ω–∫—Ü–∏—è)
    pass


def reg(dp: Dispatcher):
    dp.message.register(on_start, Command("start"))
    dp.message.register(terms_cmd, Command("terms"))
    dp.message.register(new_message)
